{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": "dist-backup",
  "sourcesContent": ["/**\r\n * Worker de backup autom\u00E1tico D1 \u2192 R2\r\n * Ejecutado diariamente por Cron Trigger (0 0 * * * = medianoche UTC)\r\n */\r\nimport {\r\n  WorkflowEntrypoint,\r\n  WorkflowStep,\r\n  WorkflowEvent,\r\n} from \"cloudflare:workers\";\r\n\r\ntype Env = {\r\n  BACKUP_WORKFLOW: Workflow;\r\n  D1_REST_API_TOKEN: string;\r\n  BACKUP_BUCKET: R2Bucket;\r\n  ACCOUNT_ID: string;\r\n  DATABASE_ID: string;\r\n};\r\n\r\ntype Params = {\r\n  accountId: string;\r\n  databaseId: string;\r\n};\r\n\r\nexport class BackupWorkflow extends WorkflowEntrypoint<Env, Params> {\r\n  async run(event: WorkflowEvent<Params>, step: WorkflowStep) {\r\n    const { accountId, databaseId } = event.payload;\r\n    const url = `https://api.cloudflare.com/client/v4/accounts/${accountId}/d1/database/${databaseId}/export`;\r\n    const method = \"POST\";\r\n    const headers = new Headers();\r\n    headers.append(\"Content-Type\", \"application/json\");\r\n    headers.append(\"Authorization\", `Bearer ${this.env.D1_REST_API_TOKEN}`);\r\n\r\n    const bookmark = await step.do(\r\n      `Iniciando backup D1 para ${databaseId}`,\r\n      async () => {\r\n        const payload = { output_format: \"polling\" };\r\n        const res = await fetch(url, {\r\n          method,\r\n          headers,\r\n          body: JSON.stringify(payload),\r\n        });\r\n        const json = (await res.json()) as { result?: { at_bookmark?: string } };\r\n        const result = json.result;\r\n        if (!result?.at_bookmark) {\r\n          throw new Error(\r\n            `Fallo al iniciar exportaci\u00F3n: ${JSON.stringify(json)}`\r\n          );\r\n        }\r\n        return result.at_bookmark;\r\n      }\r\n    );\r\n\r\n    await step.do(\"Obtener dump y guardar en R2\", async () => {\r\n      const payload = { current_bookmark: bookmark };\r\n      const res = await fetch(url, {\r\n        method,\r\n        headers,\r\n        body: JSON.stringify(payload),\r\n      });\r\n      const json = (await res.json()) as {\r\n        result?: { signed_url?: string; filename?: string };\r\n      };\r\n      const result = json.result;\r\n      if (!result?.signed_url) {\r\n        throw new Error(\r\n          `Dump a\u00FAn no disponible (polling): ${JSON.stringify(json)}`\r\n        );\r\n      }\r\n\r\n      const dumpResponse = await fetch(result.signed_url);\r\n      if (!dumpResponse.ok) {\r\n        throw new Error(\"Error al descargar el dump de D1\");\r\n      }\r\n\r\n      const today = new Date().toISOString().slice(0, 10);\r\n      const objectKey = `backup-${today}.sql`;\r\n\r\n      await this.env.BACKUP_BUCKET.put(objectKey, dumpResponse.body);\r\n\r\n      return { saved: objectKey };\r\n    });\r\n  }\r\n}\r\n\r\nexport default {\r\n  async fetch(_req: Request, env: Env): Promise<Response> {\r\n    return new Response(\"Backup worker. Use Cron o triggers.\", { status: 404 });\r\n  },\r\n\r\n  async scheduled(\r\n    _controller: ScheduledController,\r\n    env: Env,\r\n    _ctx: ExecutionContext\r\n  ): Promise<void> {\r\n    const params: Params = {\r\n      accountId: env.ACCOUNT_ID,\r\n      databaseId: env.DATABASE_ID,\r\n    };\r\n    const instance = await env.BACKUP_WORKFLOW.create({ params });\r\n    console.log(`Workflow de backup iniciado: ${instance.id}`);\r\n  },\r\n};\r\n"],
  "mappings": ";;;;AAIA;AAAA,EACE;AAAA,OAGK;AAeA,IAAM,iBAAN,cAA6B,mBAAgC;AAAA,EAvBpE,OAuBoE;AAAA;AAAA;AAAA,EAClE,MAAM,IAAI,OAA8B,MAAoB;AAC1D,UAAM,EAAE,WAAW,WAAW,IAAI,MAAM;AACxC,UAAM,MAAM,iDAAiD,SAAS,gBAAgB,UAAU;AAChG,UAAM,SAAS;AACf,UAAM,UAAU,IAAI,QAAQ;AAC5B,YAAQ,OAAO,gBAAgB,kBAAkB;AACjD,YAAQ,OAAO,iBAAiB,UAAU,KAAK,IAAI,iBAAiB,EAAE;AAEtE,UAAM,WAAW,MAAM,KAAK;AAAA,MAC1B,4BAA4B,UAAU;AAAA,MACtC,YAAY;AACV,cAAM,UAAU,EAAE,eAAe,UAAU;AAC3C,cAAM,MAAM,MAAM,MAAM,KAAK;AAAA,UAC3B;AAAA,UACA;AAAA,UACA,MAAM,KAAK,UAAU,OAAO;AAAA,QAC9B,CAAC;AACD,cAAM,OAAQ,MAAM,IAAI,KAAK;AAC7B,cAAM,SAAS,KAAK;AACpB,YAAI,CAAC,QAAQ,aAAa;AACxB,gBAAM,IAAI;AAAA,YACR,oCAAiC,KAAK,UAAU,IAAI,CAAC;AAAA,UACvD;AAAA,QACF;AACA,eAAO,OAAO;AAAA,MAChB;AAAA,IACF;AAEA,UAAM,KAAK,GAAG,gCAAgC,YAAY;AACxD,YAAM,UAAU,EAAE,kBAAkB,SAAS;AAC7C,YAAM,MAAM,MAAM,MAAM,KAAK;AAAA,QAC3B;AAAA,QACA;AAAA,QACA,MAAM,KAAK,UAAU,OAAO;AAAA,MAC9B,CAAC;AACD,YAAM,OAAQ,MAAM,IAAI,KAAK;AAG7B,YAAM,SAAS,KAAK;AACpB,UAAI,CAAC,QAAQ,YAAY;AACvB,cAAM,IAAI;AAAA,UACR,wCAAqC,KAAK,UAAU,IAAI,CAAC;AAAA,QAC3D;AAAA,MACF;AAEA,YAAM,eAAe,MAAM,MAAM,OAAO,UAAU;AAClD,UAAI,CAAC,aAAa,IAAI;AACpB,cAAM,IAAI,MAAM,kCAAkC;AAAA,MACpD;AAEA,YAAM,SAAQ,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE;AAClD,YAAM,YAAY,UAAU,KAAK;AAEjC,YAAM,KAAK,IAAI,cAAc,IAAI,WAAW,aAAa,IAAI;AAE7D,aAAO,EAAE,OAAO,UAAU;AAAA,IAC5B,CAAC;AAAA,EACH;AACF;AAEA,IAAO,gBAAQ;AAAA,EACb,MAAM,MAAM,MAAe,KAA6B;AACtD,WAAO,IAAI,SAAS,uCAAuC,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC5E;AAAA,EAEA,MAAM,UACJ,aACA,KACA,MACe;AACf,UAAM,SAAiB;AAAA,MACrB,WAAW,IAAI;AAAA,MACf,YAAY,IAAI;AAAA,IAClB;AACA,UAAM,WAAW,MAAM,IAAI,gBAAgB,OAAO,EAAE,OAAO,CAAC;AAC5D,YAAQ,IAAI,gCAAgC,SAAS,EAAE,EAAE;AAAA,EAC3D;AACF;",
  "names": []
}
