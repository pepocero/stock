<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#1a1d23">
  <title>Stock Recambios - Control de inventario</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="theme-light">
  <div class="app">
    <header class="header">
      <button id="btn-menu-toggle" class="btn-burger" type="button" aria-label="Abrir men煤 de navegaci贸n">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="header-main">
        <h1>Stock Recambios</h1>
      </div>
      <div class="header-actions">
        <div class="theme-toggle" aria-label="Cambiar tema">
          <button id="btn-theme-light" type="button" title="Modo claro"></button>
          <button id="btn-theme-dark" type="button" title="Modo oscuro"></button>
        </div>
      </div>
    </header>

    <button id="sidebar-backdrop" class="sidebar-backdrop hidden" aria-hidden="true"></button>
    <aside id="sidebar" class="sidebar" aria-label="Navegaci贸n principal">
      <div class="sidebar-header">
        <h2>Men煤</h2>
      </div>
      <nav class="sidebar-nav">
        <button class="tab sidebar-link" data-view="listado">Listado</button>
        <button class="tab sidebar-link" data-view="nuevo">Nuevo recambio</button>
        <button class="tab sidebar-link" data-view="importar">Importar</button>
        <button class="tab sidebar-link" data-view="fabricantes">Fabricantes</button>
        <button class="tab sidebar-link" data-view="utilizados">Recambios Utilizados</button>
        <button class="tab sidebar-link" data-view="pendientes">Pendientes</button>
      </nav>
      <div class="sidebar-footer">
        <button type="button" id="btn-instalar-app" class="btn btn-primary sidebar-install hidden">
          Instalar app
        </button>
        <span id="app-version" class="app-version" aria-label="Versi贸n de la aplicaci贸n"></span>
      </div>
    </aside>

    <main class="content">
      <h2 id="content-title" class="content-title">Listado</h2>
      <!-- Vista: Listado -->
      <section id="view-listado" class="view active">
        <div class="filters">
          <div class="filters-group">
            <select id="filter-fabricante">
              <option value="">Todos los fabricantes</option>
            </select>
            <select id="filter-sort" title="Ordenar por">
            <option value="nombre-asc" selected>Nombre (A-Z)</option>
            <option value="nombre-desc">Nombre (Z-A)</option>
            <option value="codigo-asc">C贸digo (A-Z)</option>
            <option value="codigo-desc">C贸digo (Z-A)</option>
            <option value="fabricante-asc">Fabricante (A-Z)</option>
            <option value="fabricante-desc">Fabricante (Z-A)</option>
            <option value="cantidad-asc">Stock (menor a mayor)</option>
            <option value="cantidad-desc">Stock (mayor a menor)</option>
            <option value="updated_at-desc">M谩s recientes</option>
            <option value="updated_at-asc">M谩s antiguos</option>
          </select>
          </div>
          <input type="search" id="filter-search" placeholder="Buscar en tiempo real por c贸digo, nombre, alias, observaciones...">
          <button id="btn-buscar">Buscar</button>
          <button type="button" id="btn-eliminar-seleccionados" class="btn btn-danger btn-sm hidden" title="Eliminar seleccionados">Eliminar seleccionados</button>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-checkbox">
                  <input type="checkbox" id="select-all-recambios" title="Seleccionar todos" aria-label="Seleccionar todos">
                </th>
                <th>C贸digo</th>
                <th>Alias</th>
                <th>Nombre</th>
                <th>Fabricante</th>
                <th class="col-cantidad">Stock</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr><td colspan="7" class="loading">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Vista: Nuevo recambio -->
      <section id="view-nuevo" class="view">
        <form id="form-nuevo" class="form-recambio">
          <div class="form-grid">
            <div class="field">
              <label for="nuevo-codigo">C贸digo *</label>
              <input type="text" id="nuevo-codigo" required placeholder="Ej: AZC-001">
            </div>
            <div class="field">
              <label for="nuevo-nombre">Nombre *</label>
              <input type="text" id="nuevo-nombre" required placeholder="Nombre del recambio">
            </div>
            <div class="field">
              <label for="nuevo-fabricante">Fabricante *</label>
              <select id="nuevo-fabricante" required>
                <option value="">Seleccionar...</option>
              </select>
            </div>
            <div class="field">
              <label for="nuevo-alias">Alias</label>
              <input type="text" id="nuevo-alias" placeholder="Nombre coloquial (opcional)">
            </div>
            <div class="field">
              <label for="nuevo-cantidad">Stock *</label>
              <input type="number" id="nuevo-cantidad" min="0" max="20" value="0" required>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar recambio</button>
            <button type="reset" class="btn btn-secondary">Limpiar</button>
          </div>
        </form>
      </section>

      <!-- Vista: Importar -->
      <section id="view-importar" class="view">
        <div class="form-recambio import-section">
          <p class="import-desc">Sube un archivo CSV o Excel (.xlsx) con los recambios. Luego asigna cada columna del archivo al campo correspondiente.</p>
          <div class="import-upload">
            <input type="file" id="import-file" accept=".csv,.xlsx,.xls" hidden>
            <button type="button" id="btn-select-file" class="btn btn-secondary">Seleccionar archivo CSV o Excel</button>
            <span id="import-filename" class="import-filename"></span>
          </div>
          <div id="import-mapping" class="import-mapping hidden">
            <h4>Asignar columnas</h4>
            <p class="import-mapping-hint">Indica qu茅 columna del archivo corresponde a cada campo. Selecciona al menos un campo. Deja en blanco para no importar esa columna.</p>
            <div id="import-mapping-fields" class="import-mapping-fields"></div>
            <div class="import-preview-section">
              <h4>Vista previa (primeras 5 filas)</h4>
              <div class="table-container import-preview-table">
                <table class="data-table" id="import-preview-table">
                  <thead id="import-preview-thead"></thead>
                  <tbody id="import-preview-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="form-actions">
              <button type="button" id="btn-importar" class="btn btn-primary">Importar recambios</button>
              <button type="button" id="btn-import-reset" class="btn btn-secondary">Cambiar archivo</button>
            </div>
          </div>
          <div id="import-result" class="import-result hidden"></div>
        </div>
      </section>

      <!-- Vista: Fabricantes -->
      <section id="view-fabricantes" class="view">
        <div class="form-recambio">
          <p class="campos-desc">Configura los fabricantes disponibles. Se usar谩n al crear o editar recambios y al filtrar el listado.</p>
          <div id="fabricantes-lista" class="campos-lista"></div>
          <div class="campos-nuevo">
            <input type="text" id="nuevo-fabricante-nombre" placeholder="Nombre del fabricante (ej: Azkoyen, Jofemar)">
            <button type="button" id="btn-add-fabricante" class="btn btn-primary">A帽adir fabricante</button>
          </div>
        </div>
      </section>

      <!-- Vista: Pendientes -->
      <section id="view-pendientes" class="view">
        <div class="registros-section">
          <div class="pendientes-filters">
            <div class="filters-row">
              <label for="pendientes-fecha">Fecha exacta</label>
              <input type="date" id="pendientes-fecha" class="input-fecha">
            </div>
            <div class="filters-row">
              <label for="pendientes-fecha-desde">Desde</label>
              <input type="date" id="pendientes-fecha-desde" class="input-fecha">
            </div>
            <div class="filters-row">
              <label for="pendientes-fecha-hasta">Hasta</label>
              <input type="date" id="pendientes-fecha-hasta" class="input-fecha">
            </div>
            <button type="button" id="btn-pendientes-buscar" class="btn btn-primary btn-sm">Buscar</button>
            <button type="button" id="btn-pendientes-limpiar" class="btn btn-secondary btn-sm">Limpiar</button>
          </div>
          <div class="registros-toolbar">
            <div class="exportar-dropdown-wrapper" id="exportar-pendientes-wrapper">
              <button type="button" id="btn-exportar-pendientes" class="btn btn-primary btn-sm hidden">Exportar</button>
            </div>
          </div>
          <div id="pendientes-list" class="pendientes-list"></div>
        </div>
      </section>

      <!-- Vista: Recambios Utilizados -->
      <section id="view-utilizados" class="view">
        <div class="registros-section">
          <div class="registros-filters">
            <input type="search" id="filter-utilizados" placeholder="Buscar por fecha o nombre de recambio..." class="filter-search">
          </div>
          <div class="registros-toolbar">
            <div class="exportar-dropdown-wrapper hidden" id="exportar-seleccionados-wrapper">
              <button type="button" id="btn-exportar-utilizados-seleccionados" class="btn btn-primary btn-sm">Exportar seleccionados</button>
            </div>
            <button type="button" id="btn-borrar-utilizados-seleccionados" class="btn btn-danger btn-sm hidden">Borrar seleccionados</button>
          </div>
          <div id="utilizados-list" class="registros-por-fecha"></div>
        </div>
      </section>

      <!-- Vista: Campos adicionales (editar nombres) -->
      <section id="view-campos" class="view">
        <div class="form-recambio">
          <p class="campos-desc">Define los nombres de los campos extra que aparecer谩n al crear o editar recambios. El valor lo asigna el usuario en cada recambio.</p>
          <div id="campos-lista" class="campos-lista"></div>
          <div class="campos-nuevo">
            <input type="text" id="nuevo-campo-nombre" placeholder="Nombre del nuevo campo (ej: Ubicaci贸n, Proveedor)">
            <button type="button" id="btn-add-campo" class="btn btn-primary">A帽adir campo</button>
          </div>
        </div>
      </section>

      <!-- Vista: Detalle recambio (panel deslizante) -->
      <section id="view-detalle" class="view view-panel">
        <div class="panel-header">
          <h2>Detalle del recambio</h2>
          <button id="btn-cerrar-detalle" class="btn-close"></button>
        </div>
        <div id="detalle-content" class="detalle-content">
          <div class="detalle-section utilizados-section">
            <h3 class="detalle-section-title">Recambio Utilizado</h3>
            <div class="detalle-accion-row">
              <input type="date" id="detalle-fecha-utilizado" class="input-fecha">
              <select id="detalle-cantidad-utilizado" class="select-cantidad">
                <option value="0">0</option>
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
              </select>
              <label class="detalle-check-usado"><input type="checkbox" id="detalle-usado" title="Marcar si el recambio es usado"> Usado</label>
              <button type="button" id="btn-check-utilizado" class="btn btn-check btn-check-utilizado" title="Registrar uso">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </button>
            </div>
          </div>
          <div id="detalle-info" class="detalle-info"></div>
        </div>
        <div class="form-actions detalle-actions">
          <div class="detalle-actions-left">
            <button type="button" id="btn-editar-desde-detalle" class="btn btn-primary">Editar</button>
            <button type="button" id="btn-cerrar-detalle-abajo" class="btn btn-secondary">Cerrar</button>
          </div>
          <button type="button" id="btn-eliminar-desde-detalle" class="btn btn-danger btn-trash" title="Eliminar" aria-label="Eliminar">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </button>
        </div>
      </section>

      <!-- Vista: Editar recambio (modal/panel) -->
      <section id="view-editar" class="view view-panel">
        <div class="panel-header">
          <h2>Editar recambio</h2>
          <button id="btn-cerrar-editar" class="btn-close"></button>
        </div>
        <form id="form-editar" class="form-recambio">
          <input type="hidden" id="editar-id">
          <div class="form-grid">
            <div class="field">
              <label for="editar-codigo">C贸digo *</label>
              <input type="text" id="editar-codigo" required>
            </div>
            <div class="field">
              <label for="editar-nombre">Nombre *</label>
              <input type="text" id="editar-nombre" required>
            </div>
            <div class="field">
              <label for="editar-fabricante">Fabricante *</label>
              <select id="editar-fabricante" required>
              </select>
            </div>
            <div class="field">
              <label for="editar-alias">Alias</label>
              <input type="text" id="editar-alias" placeholder="Nombre coloquial (opcional)">
            </div>
            <div class="field field-stock">
              <label for="editar-cantidad">Stock *</label>
              <select id="editar-cantidad" required>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
              </select>
              <span id="stock-bajo-badge" class="badge badge-warning hidden">Stock bajo</span>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
            <button type="button" id="btn-cancelar-editar" class="btn btn-secondary">Cancelar</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <!-- Modal notificaci贸n (Recambio Utilizado/Recuperado) -->
  <!-- Modal detalle registro utilizado -->
  <div id="modal-utilizado-detalle" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-utilizado-detalle-titulo">
    <div class="modal-notificacion-box modal-utilizado-detalle-box">
      <h2 id="modal-utilizado-detalle-titulo" class="modal-notificacion-titulo">Detalle del registro</h2>
      <div id="modal-utilizado-detalle-content" class="modal-utilizado-detalle-content"></div>
      <button type="button" id="btn-cerrar-modal-utilizado" class="btn btn-primary">Cerrar</button>
    </div>
  </div>

  <div id="modal-notificacion" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-notificacion-titulo">
    <div class="modal-notificacion-box">
      <h2 id="modal-notificacion-titulo" class="modal-notificacion-titulo"></h2>
      <p class="modal-notificacion-mensaje"></p>
      <button type="button" id="btn-cerrar-modal-notificacion" class="btn btn-primary">Aceptar</button>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
